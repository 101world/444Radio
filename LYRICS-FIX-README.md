# Lyrics Fix - Manual Steps Required

## Issue
Lyrics are saved to `music_library` during generation but not flowing through to `combined_media` table used by Explore/Library/Profile pages.

## Solution
1. **Add lyrics columns** to `combined_media` and `combined_media_library` tables
2. **Update API logic** to fetch and save lyrics when combining music + cover art
3. **Re-publish existing tracks** to populate lyrics (optional)

---

## Step 1: Run SQL in Supabase

**Go to Supabase Dashboard → SQL Editor → New Query**

Paste and run this SQL:

```sql
-- Add lyrics column to combined_media and combined_media_library tables
-- This allows us to store and retrieve lyrics for tracks displayed in Explore, Library, and Profile pages

-- Add to combined_media table (public explore/profile view)
ALTER TABLE public.combined_media 
ADD COLUMN IF NOT EXISTS lyrics TEXT;

-- Add to combined_media_library table (user's private library)
ALTER TABLE public.combined_media_library 
ADD COLUMN IF NOT EXISTS lyrics TEXT;

-- Create index for lyrics search (optional, for future lyrics search feature)
CREATE INDEX IF NOT EXISTS idx_combined_media_lyrics 
  ON public.combined_media USING gin(to_tsvector('english', lyrics));

-- Comments for documentation
COMMENT ON COLUMN public.combined_media.lyrics IS 'Song lyrics for audio tracks. Can be generated by AI or user-provided.';
COMMENT ON COLUMN public.combined_media_library.lyrics IS 'Song lyrics for audio tracks. Can be generated by AI or user-provided.';
```

---

## Step 2: Deploy Updated Code

The following files have been updated to handle lyrics:

- ✅ `app/api/library/combined/route.ts` (POST) - Fetches lyrics from music_library when combining
- ✅ `app/api/library/combined/route.ts` (PATCH) - Includes lyrics when publishing to combined_media

Build and deploy:

```powershell
npm run build
git add -A
git commit -m "fix: Add lyrics support to combined_media flow

- Add lyrics column to combined_media and combined_media_library tables
- Update POST /api/library/combined to fetch lyrics from music_library
- Update PATCH /api/library/combined to include lyrics when publishing
- Fixes 'View Lyrics' button showing empty content in Library/Explore"
git push origin master
vercel --prod --yes
```

---

## Step 3: Test

1. **New generations**: Create a new track → Combine with cover → Publish → Check "View Lyrics" button ✅
2. **Existing tracks**: Will need to be re-published or manually updated (see Step 4)

---

## Step 4: Backfill Existing Tracks (Optional)

If you have existing published tracks without lyrics, run this SQL to copy lyrics from music_library:

```sql
-- Update combined_media_library with lyrics from music_library
UPDATE combined_media_library cml
SET lyrics = ml.lyrics
FROM music_library ml
WHERE cml.music_id = ml.id
  AND cml.lyrics IS NULL
  AND ml.lyrics IS NOT NULL;

-- Update combined_media with lyrics from combined_media_library
UPDATE combined_media cm
SET lyrics = cml.lyrics
FROM combined_media_library cml
WHERE cm.audio_url = cml.audio_url
  AND cm.lyrics IS NULL
  AND cml.lyrics IS NOT NULL;
```

---

## Verification

After deployment, test the lyrics flow:

1. **Create page**: Generate music → Should have lyrics in music_library ✅
2. **Library page**: Combine music + cover → Should save lyrics to combined_media_library ✅
3. **Publish**: Release to profile → Should save lyrics to combined_media ✅
4. **Explore/Library**: Click "View Lyrics" → Should display lyrics from combined_media ✅

---

## Files Modified

- `db/migrations/003_add_lyrics_to_combined_media.sql` - Migration SQL
- `app/api/library/combined/route.ts` - API logic updates
- This README file

---

## Next Steps

Once SQL is run and code is deployed:
- Test new generation flow end-to-end
- Optionally run backfill SQL for existing tracks
- Delete this README or move to docs/ folder
